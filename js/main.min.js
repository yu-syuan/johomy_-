/*
  Miya紅利館JS整理
 */
// 20170724新增-兌換清單用(刪除商品及顯示需填寫資訊)
// 20170731新增-商品件數計算
bonus_checkout = 0; //全域變數控制是否在結帳頁
$(function() {
  $(".buy a").addClass("active")
  $(".font_color_Red").html(""); //20170906更新
  if (bonus_checkout){ 
    point_check(); // memeber point check
    $("#members").hide();
    if (members){
      $("#members").show();
      $("#the_same_member").click(function(){
        $("#receive_name").val("");
        $("#receive_phone").val("");
        $("#state_id").val(0);
        $("#city_id").html("");
        $("#address").val("");
        if ($(this).is(":checked")){
          $("#receive_name").val(member_address.name);
          $("#receive_phone").val(member_address.mobile);
          $("#state_id").val(member_address.state_id);
          $("#address").val(member_address.address);
          getAddressList(member_address.state_id,$("#city_id"),member_address.city_id);
        }
      });
    }
    //點擊刪除鍵 刪除商品 商品件數計算
    $(".ProdDelete").click(function(){
      //var C = parseInt($(".pieces_wrap").length); //宣告C為當前商品的件數
      //$("#pieces").html(C);
      if(confirm("是否要將此商品移除?")){ //確認是否要刪除商品
        //$(this).parents("#ProdDelete").remove(); //按確定就刪除
        //C -= 1; //件數-1
        var sn = $(this).attr("sn");
        //$("#ProdDelete"+sn).remove();
        var data_sn = $(this).attr("data_sn");
        var deliver_method_id = $(this).attr("deliver_method_id");
        var cart_obj = {
                        "sn" : data_sn,
                        "qty" : 0,
                        "deliver_method_id" : deliver_method_id
                       };
        updToBonusCart(cart_obj,sn,0);
      } else {
        return false; //按取消就停止動作
      }
      //$("#pieces").html(C);
    });
    $("#state_id").change(function(){
      var id = $(this).val();
      getAddressList(id,$("#city_id"),0);
    });
    $("#state_id2").change(function(){
      var id = $(this).val();
      getAddressList(id,$("#city_id2"),0);
    });
    //勾選索取三聯式發票 顯示需填寫資訊
    $(".Show_information").hide();
    $("#get_einvoice").click(function(){
      $(".Show_information").hide();
      if ($(this).is(":checked")){
        $(".Show_information").toggle(300);
      }
    });
    $(".checkout_next_btn").click(function(){
      var check = 0;
      var receive_name = $("#receive_name").val();
      var receive_phone = $("#receive_phone").val();
      $("#point_less").hide();
      $(".checkout_next_btn").text("下一步").prop("disabled",false);
      if (member_bonus < point_fee){
        $("#point_less").show();
        check++;
        $(".checkout_next_btn").text("紅利點數不足，無法兌換。").prop("disabled",true);
        return false;
      }
      $("#error_payment").html("");
      if (shipping_fee > 0){
        var checkout_payment = $(".checkout_payment:checked").val();
        if (typeof(checkout_payment) == "undefined"){
          $("#error_payment").show().html("請選擇付費方式");
          check++;
          return false;
        }
        if ($("#get_einvoice").is(":checked")){
          var company_title = $("#company_title").val();
          var company_no = $("#company_no").val();
          var company_receive_name = $("#company_receive_name").val();
          rs = checkCompanyInfo(company_title,company_no,company_receive_name,
                                "#error_company_title","#error_company_no","#error_company_receive_name");
          if (rs == 0){
            check++;
          }
          var state_id2 = $("#state_id2").val();
          var city_id2 = $("#city_id2").val();
          var invoice_address = $("#invoice_address").val();
          rs = checkAddress(state_id2,city_id2,invoice_address,"#error_invoice_address");
          if (rs == 0){
            check++;
          }
        }
      }
      var rs = 0;
      rs = checkNamePhone(receive_name,receive_phone,"#error_receive_name","#error_receive_phone");
      if (rs == 0){
        check++;
      }
      var checkout_model = $("#checkout_model").val();
      if (parseInt(checkout_model) == 1){
        var state_id = $("#state_id").val();
        var city_id = $("#city_id").val();
        var address = $("#address").val();
        rs = checkAddress(state_id,city_id,address,"#error_address");
        if (rs == 0){
          check++;
        }
      }
      var order_memo = $("#order_memo").val();
      $("#error_order_memo").html("");
      if ($.trim(order_memo) != ""){
        if (isSpecialChar(order_memo)){
          $("#error_order_memo").html("請勿輸入特殊符號");
          check++;
        }
      }
      if (check > 0){
        return false;
      }
      $("#checkout_order_form").submit();
      return true;
    });
  }
  //20170727新增-數量加減點擊
  //20170728新增-點擊數量後有計算功能
  //20170729新增-兌換使用點數計算
  //增加按鈕設定
  $(".addition").click(function(){ 
    $(".font_color_Red").html(""); //當出現警示時，隱藏警示文字 //20170906更新
    var sn = $(this).siblings(".price").attr("sn"); //宣告sn為當前有class="price"裡sn的值
    var num = $(this).siblings(".Quantity"); //宣告當前num為當前class="Quantity"的值
    var pri = $(this).siblings(".price").attr("unit_price"); //宣告單價為當前unit_price的值
    if (parseInt(num.val()) < 10) { //如果值小於10時做+1的動作
      num.val(parseInt(num.val())+1); 
      if (bonus_checkout){
        var prod_name = $("#p_name"+sn).text();
        if (confirm("確定增加 "+prod_name+" 的兌換數量?")){
          var data_sn = $(this).attr("data_sn");
          var deliver_method_id = $(this).attr("deliver_method_id");
          var cart_obj = {
                          "sn" : data_sn,
                          "qty" : num.val(),
                          "deliver_method_id" : deliver_method_id
                         };
          updToBonusCart(cart_obj,sn,num.val());
        } else {
          num.val(parseInt(num.val())-1);
        }
      }
    } else { //否則顯示警示
      $("#error_Quantity_"+sn).show().html("★已達數量限制");//20170906更新
    }
    //在id="point_?"顯示num*單價的值
    $("#point_"+sn).html(num.val()*pri);
  });
  //::減少按鈕設定
  $(".cut_back").click(function(){
    $(".font_color_Red").html(""); //當出現警示時，隱藏警示文字 //20170906更新
    var sn = $(this).siblings(".price").attr("sn"); //宣告sn為當前有class="price"裡sn的值
    var num = $(this).siblings(".Quantity"); //宣告當前num為當前class="Quantity"的值
    var pri = $(this).siblings(".price").attr("unit_price"); //宣告單價為當前unit_price的值
    if (parseInt(num.val()) > 1) { //如果值大於1時做-1的動作
      num.val(parseInt(num.val())-1)
      if (bonus_checkout){
        var prod_name = $("#p_name"+sn).text();
        if (confirm("確定減少 "+prod_name+" 的兌換數量?")){
          var data_sn = $(this).attr("data_sn");
          var deliver_method_id = $(this).attr("deliver_method_id");
          var cart_obj = {
                          "sn" : data_sn,
                          "qty" : num.val(),
                          "deliver_method_id" : deliver_method_id
                         };
          updToBonusCart(cart_obj,sn,num.val());
        } else {
          num.val(parseInt(num.val())+1);
        }
      }
    } else { //否則顯示警示
      //$(this).siblings(".remind_color").show();
      // $("#error_Quantity_"+sn).show().html("★已達數量限制");
    }
    //在id="point_?"顯示num*單價的值
    $("#point_"+sn).html(num.val()*pri);
  });
  $(".exchange_now").click(function(){
    var sn = $(this).attr("sn");
    var cart_obj = {
                    "deliver_method_id" : $(this).attr("deliver_method_id"),
                    "bonus_product_id" : $(this).attr("bonus_id"),
                    "qty" : $("#qty"+sn).val()
                   };
    if ($("#qty"+sn).val() > 0){
      addToBonusCart(cart_obj,1);
    }
  });
  $(".add_bonus_cart").click(function(){
    var sn = $(this).attr("sn");
    var cart_obj = {
                    "deliver_method_id" : $(this).attr("deliver_method_id"), 
                    "bonus_product_id" : $(this).attr("bonus_id"),
                    "qty" : $("#qty"+sn).val()
                   };
    if ($("#qty"+sn).val() > 0){
      addToBonusCart(cart_obj,0);
    }
  });
  // // 20171005 Footer架構變動 因此變更顯示方式
  $(".buy div").addClass("active");
  $(".buy img").attr("src","images/menu_icon_buy_1.png");
  $(".buy a").css("color","white");
});
//兌換使用點數計算
function setTotal(msg){
  var member_point = 0;
  //var exchange_point = 0;
  //var A = 0;
  //var B = 0;
  member_point = parseInt($("#hold_points").attr("hold_points"));
  //A = parseInt($("#point_a").html());
  //B = parseInt($("#point_b").html());
  /*$(".points").each(function(){
    exchange_point += parseInt($(this).text());
  });*/
  $("#remaining_points").html("0");
  //$("#point_totals").html(exchange_point);
  if (member_point - parseInt(msg.point_fee) >= 0){
    $("#remaining_points").html(member_point - parseInt(msg.point_fee));
  }
  $("#shipping_fees").text(msg.shipping_fee);
  $("#point_totals").text(msg.point_fee);
  $("#pieces").text(msg.prod_cnt);
}
// ajax for data 20170807
function addToBonusCart(cart_obj,checkout){
  $.ajax({
      cache: false,
      method : "POST",
      url: "/bonus_add_cart/",
      dataType : "json",
      data : cart_obj
  }).done(function(msg) {
    var ok = 0;
    if (msg.code == 1){
      ok = 1;
    } else {
      alert("系統忙碌中!請稍等幾秒後再次嘗試一次。");
    }
    if (ok == 1){
      if (checkout == 1){
        top.location.href="/bonus_checkout/"+cart_obj.deliver_method_id;
      } else {
        alert("加入清單完成!");
      }
    }
  });
}
// ajax fo data 20170807
function updToBonusCart(cart_obj,sn,qty){
  $.ajax({
    cache: false,
    method : "POST",
    url: "/bonus_upd_cart/",
    dataType : "json",
    data : cart_obj
  }).done(function(msg) {
    console.log(msg);
    if (qty == 0){
      $("#ProdDelete"+sn).remove();
    }
    setTotal(msg);
    member_bonus = parseInt(msg.member_bonus);
    point_fee = parseInt(msg.point_fee);
    shipping_fee = parseInt(msg.shipping_fee);
    point_check();
    if ($.isEmptyObject(msg)){
      alert('兌換清單已清空');
      top.location.href="/bonus_home";
    }
  });
}
function getAddressList(id,dom_obj,select_id){
  dom_obj.html("");
  if (parseInt(id) > 0){
    var city = "<option value='0'>-- 請選擇 --</option>";
    $.each(cityList[id],function(k1,v1){
      if (v1.id == select_id){
        city += "<option value='"+k1+"' selected='selected'>"+v1.postcode+"-"+v1.name+"</option>";
      } else {
        city += "<option value='"+k1+"'>"+v1.postcode+"-"+v1.name+"</option>";
      }
    });
    dom_obj.html(city);
  }
}
function checkAddress(state_id,city_id,address,error_address){
  $(error_address).show().html("");
  if (parseInt(state_id) == 0){
    $(error_address).show().html("請選擇縣市");
    return 0;
  }
  if (parseInt(city_id) == 0){
    $(error_address).show().html("請選擇鄉鎮市區");
    return 0;
  }
  if ($.trim(address) == ""){
    $(error_address).show().html("地址請勿空白");
    return 0;
  }
  if (isSpecialChar(address)){
    $(error_address).show().html("請勿輸入特殊符號");
    return 0;
  }
  return 1;
}
function isSpecialChar(str){
  Rule = /^[\u4E00-\u9FA5_a-zA-Z0-9\s\,\.]+$/;
  if (!str.match(Rule)){
    return 1;
  }
  return 0;
}
function checkNamePhone(name,phone,error_name,error_phone){
  var returnValue = 1;
  $(error_name).show().html("");
  $(error_phone).show().html("");
  if ($.trim(name)==""){
    $(error_name).show().html("姓名請勿空白");
    returnValue = 0;
  }
  var cnCheck = isChinese(name);
  if (!cnCheck){
    $(error_name).show().html("姓名請輸入中文");
    returnValue = 0;
  }
  var mobileCheck = isMobileFormat(phone);
  if (!mobileCheck){
    $(error_phone).show().html("手機格式為09開頭的10位數字");
    returnValue = 0;
  }
  return returnValue;
}
function isChinese(str){
  cnRule = /[^\u4E00-\u9FA5]/g;
  if (str.match(cnRule)){
    return 0;
  }
  return 1;
}
function isMobileFormat(str){
  mobileRule = /^09\d{8}$/;
  if (mobileRule.test(str)){
    return 1;
  }
  return 0;
}
function checkCompanyInfo(company_title,company_no,company_receive_name,
                          error_company_title,error_company_no,error_company_receive_name){
  var returnValue = 1;
  $(error_company_title).show().html("");
  $(error_company_no).show().html("");
  $(error_company_receive_name).show().html("");
  if ($.trim(company_title) == ""){
    $(error_company_title).show().html("請輸入抬頭");
    returnValue = 0;
  } else {
    if (!isChinese(company_title)){
      $(error_company_title).show().html("姓名請輸入中文");
      returnValue = 0;
    }
  }
  companyNoRule = /^\d{8}$/;
  if ($.trim(company_no) == ""){
    $(error_company_no).show().html("請輸入統一編號");
    returnValue = 0;
  } else {
    if (!company_no.match(companyNoRule)){
      $(error_company_no).show().html("請輸入8位數字");
      returnValue = 0;
    }
  }
  if ($.trim(company_receive_name) == ""){
    $(error_company_receive_name).show().html("請輸入發票收件人");
    returnValue = 0;
  } else {
    if (!isChinese(company_receive_name)){
      $(error_company_receive_name).show().html("姓名請輸入中文");
      returnValue = 0;
    }
  }
  return returnValue;
}
// rebuild data for all input in checkout page 20170807
function restore_info(){
  $(".checkout_payment").each(function(){
    if ($(this).val() == rebuildData.payment){
      $(this).prop("checked",true);
    }
  });
  $("#receive_name").val(rebuildData.receive_name);
  $("#receive_phone").val(rebuildData.receive_phone);
  if (typeof(rebuildData.the_same_member) != "undefined"){
    if (parseInt(rebuildData.the_same_member) == 1){
      $("#the_same_member").prop("checked",true);
    }
  }
  $("#state_id").val(rebuildData.state_id);
  getAddressList(rebuildData.state_id,$("#city_id"),rebuildData.city_id);
  $("#address").val(rebuildData.address,rebuildData.address);
  if (typeof(rebuildData.order_memo) != "undefined"){
    $("#order_memo").val(rebuildData.order_memo);
  }
  if (typeof(rebuildData.invoice_need) != "undefined"){
    $("#company_title").val(rebuildData.company_title);
    $("#company_no").val(rebuildData.company_no);
    $("#company_receive_name").val(rebuildData.company_receive_name);
    $("#state_id2").val(rebuildData.state_id2);
    getAddressList(rebuildData.state_id2,$("#city_id2"),rebuildData.city_id2);
    $("#invoice_address").val(rebuildData.invoice_address);
    if (parseInt(rebuildData.invoice_need) == 1){
      $("#get_einvoice").prop("checked",true);
      setTimeout(function () {
        $(".Show_information").show();
      },500);
    }
  }
}
function point_check(){
  $(".pay_info").hide();
  $(".checkout_next_btn").text("下一步").prop("disabled",false);
  $(".exchange_mode").show();
  if (member_bonus < point_fee){ // point check for locking
    $("#point_less").show();
    $(".checkout_next_btn").text("紅利點數不足，無法兌換。").prop("disabled",true);
    $(".exchange_mode").hide();
  } else {
    $(".pay_info").hide();
    if (shipping_fee > 0){
      $(".pay_info").show();
    }
  }
}
if (typeof(restore) != "undefined" && restore == 1){
  restore_info();
}